# 掘金量化 (GM) Python SDK 入门指南

## 一、概述

掘金量化 (GM) 是一个专业的量化交易开发平台，提供从策略研究、回测到仿真交易、实盘交易的完整解决方案。本文档整理了 GM SDK 的核心知识点，帮助快速入门。

---

## 二、策略程序架构 (重点)

### 2.1 策略基本结构

每个策略程序由三个核心部分组成：

```python
from gm.api import *

# 1. 初始化函数 - 策略启动时自动执行一次
def init(context):
    # 订阅行情、设置定时任务、初始化变量
    pass

# 2. 事件处理函数 - 响应行情/交易事件
def on_bar(context, bars):
    # 处理K线数据，执行交易逻辑
    pass

# 3. 策略入口 - 启动策略
if __name__ == '__main__':
    run(strategy_id='your_strategy_id',
        filename='main.py',
        mode=MODE_BACKTEST,  # 回测模式
        token='your_token',
        backtest_start_time='2020-01-01 08:00:00',
        backtest_end_time='2020-12-31 16:00:00',
        backtest_initial_cash=1000000)
```

### 2.2 三种常见策略结构

| 类型 | 说明 | 适用场景 |
|------|------|----------|
| **定时任务驱动** | 使用 `schedule()` 定时执行 | 选股策略、日频交易 |
| **数据事件驱动** | 使用 `subscribe()` 订阅行情，触发 `on_bar/on_tick` | 日内交易、技术指标策略 |
| **时间序列数据驱动** | 订阅时指定 `count` 参数，通过 `context.data()` 获取历史数据滑窗 | 需要历史数据计算指标的策略 |

---

## 三、核心概念 (重点)

### 3.1 Symbol 代码标识

格式：**交易所代码.标的代码**

| 交易所 | 代码 | 示例 |
|--------|------|------|
| 上交所 | SHSE | SHSE.600000 (浦发银行) |
| 深交所 | SZSE | SZSE.000001 (平安银行) |
| 中金所 | CFFEX | CFFEX.IC2011 |
| 上期所 | SHFE | SHFE.rb2011 |
| 大商所 | DCE | DCE.m2011 |
| 郑商所 | CZCE | CZCE.FG101 |
| 上海能源 | INE | INE.sc2011 |
| 广期所 | GFEX | GFEX.lc2405 |

### 3.2 运行模式

| 模式 | 常量 | 说明 |
|------|------|------|
| 实时模式 | `MODE_LIVE` | 用于仿真/实盘交易 |
| 回测模式 | `MODE_BACKTEST` | 用于策略回测验证 |

### 3.3 Context 上下文对象 (重点)

`context` 是全局变量容器，在所有函数间传递：

```python
# 常用属性
context.now         # 当前时间
context.mode        # 运行模式 (1=实时, 2=回测)
context.symbols     # 已订阅的代码集合
context.account()   # 账户对象 (资金、持仓)
context.data()      # 获取订阅数据滑窗
context.parameters  # 动态参数

# 自定义属性
context.my_variable = 100  # 可以添加任意自定义属性
```

---

## 四、数据相关函数 (重点)

### 4.1 数据订阅 - subscribe()

```python
# 订阅单个标的的分钟K线
subscribe(symbols='SHSE.600000', frequency='60s')

# 订阅多个标的，指定滑窗大小
subscribe(symbols='SHSE.600519,SZSE.000001', frequency='60s', count=50)

# 订阅tick数据
subscribe(symbols='SHSE.600519', frequency='tick')

# 常用频率：'tick', '60s', '300s', '900s', '1800s', '3600s', '1d'
```

### 4.2 数据事件处理

```python
# 处理K线数据
def on_bar(context, bars):
    for bar in bars:
        print(f"代码:{bar['symbol']}, 收盘价:{bar['close']}")

# 处理Tick数据
def on_tick(context, tick):
    print(f"最新价:{tick['price']}")
```

### 4.3 历史数据查询

```python
# 查询历史K线
data = history(symbol='SHSE.600000', 
               frequency='1d',
               start_time='2020-01-01', 
               end_time='2020-12-31',
               adjust=ADJUST_PREV,  # 前复权
               df=True)

# 查询最新N条数据
data = history_n(symbol='SHSE.600000', frequency='1d', count=100)

# 查询当前行情快照
data = current(symbols='SHSE.600000,SZSE.000001')
```

### 4.4 数据滑窗 - context.data()

```python
def init(context):
    # 订阅时指定滑窗大小
    subscribe(symbols='SHSE.600000', frequency='60s', count=50)

def on_bar(context, bars):
    # 获取最近20条K线数据
    data = context.data(symbol=bars[0]['symbol'], frequency='60s', count=20)
    # 计算均线
    data['ma5'] = data['close'].rolling(window=5).mean()
```

---

## 五、交易相关函数 (重点)

### 5.1 下单函数

```python
# 按指定数量下单 (最常用)
order_volume(symbol='SHSE.600000', 
             volume=1000,                    # 股数
             side=OrderSide_Buy,             # 买入
             order_type=OrderType_Limit,     # 限价单
             position_effect=PositionEffect_Open,  # 开仓
             price=10.5)

# 按指定金额下单
order_value(symbol='SHSE.600000', value=100000, ...)

# 按总资产比例下单
order_percent(symbol='SHSE.600000', percent=0.1, ...)

# 调仓到目标持仓量
order_target_volume(symbol='SHSE.600000', volume=1000, ...)

# 调仓到目标持仓比例
order_target_percent(symbol='SHSE.600000', percent=0.1, ...)
```

### 5.2 常用枚举常量

```python
# 委托方向
OrderSide_Buy = 1   # 买入
OrderSide_Sell = 2  # 卖出

# 委托类型
OrderType_Limit = 1   # 限价单
OrderType_Market = 2  # 市价单

# 开平仓类型
PositionEffect_Open = 1           # 开仓
PositionEffect_Close = 2          # 平仓
PositionEffect_CloseToday = 3     # 平今仓
PositionEffect_CloseYesterday = 4 # 平昨仓

# 持仓方向
PositionSide_Long = 1   # 多仓
PositionSide_Short = 2  # 空仓

# 委托状态
OrderStatus_New = 1             # 已报
OrderStatus_PartiallyFilled = 2 # 部成
OrderStatus_Filled = 3          # 已成
OrderStatus_Canceled = 5        # 已撤
OrderStatus_Rejected = 8        # 已拒绝
```

### 5.3 撤单与查询

```python
# 撤销指定委托
order_cancel(wait_cancel_orders=orders)

# 撤销所有委托
order_cancel_all()

# 查询未结委托
orders = get_unfinished_orders()

# 查询所有委托
orders = get_orders()

# 查询成交回报
reports = get_execution_reports()
```

### 5.4 账户与持仓查询

```python
# 获取账户资金
cash = context.account().cash
print(f"可用资金: {cash['available']}")
print(f"总资产: {cash['nav']}")

# 获取所有持仓
positions = context.account().positions()

# 获取指定标的持仓
position = context.account().position(symbol='SHSE.600000', side=PositionSide_Long)
if position:
    print(f"持仓量: {position['volume']}")
```

---

## 六、交易事件 (重点)

```python
# 委托状态更新事件
def on_order_status(context, order):
    if order['status'] == OrderStatus_Filled:
        print(f"委托已成交: {order['symbol']}")
    elif order['status'] == OrderStatus_Rejected:
        print(f"委托被拒绝: {order['ord_rej_reason_detail']}")

# 成交回报事件
def on_execution_report(context, execrpt):
    print(f"成交价格: {execrpt['price']}, 成交量: {execrpt['volume']}")

# 账户状态更新事件
def on_account_status(context, account):
    if account['status']['state'] == 3:
        print('账户已登录')
```

---

## 七、定时任务

```python
def init(context):
    # 每天14:50执行algo函数
    schedule(schedule_func=algo, date_rule='1d', time_rule='14:50:00')
    
    # 每月第一个交易日09:40执行
    schedule(schedule_func=monthly_algo, date_rule='1m', time_rule='09:40:00')

def algo(context):
    # 定时任务逻辑
    order_volume(...)
```

---

## 八、数据结构速查

### 8.1 Bar 对象 (K线)

| 字段 | 类型 | 说明 |
|------|------|------|
| symbol | str | 标的代码 |
| open | float | 开盘价 |
| high | float | 最高价 |
| low | float | 最低价 |
| close | float | 收盘价 |
| volume | long | 成交量 |
| amount | float | 成交额 |
| bob | datetime | K线开始时间 |
| eob | datetime | K线结束时间 |

### 8.2 Tick 对象 (分笔)

| 字段 | 类型 | 说明 |
|------|------|------|
| symbol | str | 标的代码 |
| price | float | 最新价 |
| open | float | 开盘价 |
| high | float | 最高价 |
| low | float | 最低价 |
| cum_volume | long | 累计成交量 |
| cum_amount | float | 累计成交额 |
| quotes | list | 5档盘口数据 |
| created_at | datetime | 时间 |

### 8.3 Position 对象 (持仓)

| 字段 | 类型 | 说明 |
|------|------|------|
| symbol | str | 标的代码 |
| side | int | 持仓方向 |
| volume | int | 总持仓量 |
| volume_today | int | 今日买入量 |
| available | int | 可用持仓量 |
| vwap | float | 持仓均价 |
| fpnl | float | 浮动盈亏 |

---

## 九、完整策略示例

### 9.1 简单均线策略

```python
# coding=utf-8
from gm.api import *

def init(context):
    context.symbol = 'SHSE.600000'
    context.short_period = 5
    context.long_period = 20
    
    # 订阅日K线，预留20条历史数据计算均线
    subscribe(symbols=context.symbol, frequency='1d', count=context.long_period)

def on_bar(context, bars):
    # 获取历史数据
    data = context.data(symbol=context.symbol, frequency='1d', count=context.long_period)
    
    # 计算均线
    ma_short = data['close'].rolling(context.short_period).mean().iloc[-1]
    ma_long = data['close'].rolling(context.long_period).mean().iloc[-1]
    
    # 获取当前持仓
    position = context.account().position(symbol=context.symbol, side=PositionSide_Long)
    
    # 交易逻辑
    if ma_short > ma_long:  # 金叉买入
        if position is None or position['volume'] == 0:
            order_percent(symbol=context.symbol, percent=0.8, 
                         side=OrderSide_Buy, order_type=OrderType_Market,
                         position_effect=PositionEffect_Open)
    elif ma_short < ma_long:  # 死叉卖出
        if position and position['volume'] > 0:
            order_target_volume(symbol=context.symbol, volume=0,
                               position_side=PositionSide_Long,
                               order_type=OrderType_Market)

def on_backtest_finished(context, indicator):
    print(f"回测结果: 收益率={indicator['pnl_ratio']:.2%}")

if __name__ == '__main__':
    run(strategy_id='your_strategy_id',
        filename='main.py',
        mode=MODE_BACKTEST,
        token='your_token',
        backtest_start_time='2020-01-01 08:00:00',
        backtest_end_time='2020-12-31 16:00:00',
        backtest_adjust=ADJUST_PREV,
        backtest_initial_cash=1000000,
        backtest_commission_ratio=0.0003,
        backtest_slippage_ratio=0.0001)
```

---

## 十、学习重点总结

### 必须掌握 (核心)

1. **策略架构**: `init()` + 事件函数 + `run()`
2. **数据订阅**: `subscribe()` 和 `context.data()`
3. **下单函数**: `order_volume()` 和 `order_target_percent()`
4. **账户查询**: `context.account().cash` 和 `context.account().position()`
5. **枚举常量**: 委托方向、类型、开平仓等

### 建议掌握 (进阶)

1. **历史数据**: `history()` 和 `history_n()`
2. **交易事件**: `on_order_status()` 和 `on_execution_report()`
3. **定时任务**: `schedule()`
4. **撤单操作**: `order_cancel()` 和 `get_unfinished_orders()`

### 了解即可 (高级)

1. Level2 数据函数 (付费功能)
2. 算法交易函数
3. 两融/期权交易函数
4. 动态参数

---

## 十一、常见问题

1. **回测模式下 init() 不能执行交易操作**，实盘模式可以
2. **实时模式下订阅数据是不复权的**
3. **股票买入最小单位是100股**，卖出可以1股
4. **沪市市价单必须填写保护限价 (price)**
5. **数据滑窗 count 必须 <= subscribe 时指定的 count**

---

## 十二、API 文档参考

- 官方文档: https://www.myquant.cn/docs2/sdk/python/
- 错误码参考: https://www.myquant.cn/docs2/sdk/python/错误码.html
